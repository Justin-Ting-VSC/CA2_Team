<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="/styles.css" rel="stylesheet">
</head>
<style>
        body {
            font-family: "SF Pro Display", Inter, sans-serif;
            background-color: #e6dfd0;
            color: #343a40;
        }
        .navbar {
            background-color: #4B2E2E !important;
            margin-bottom: 20px;
            border-radius: 0 0 10px 10px;
        }
        .nav-link {
            color: #F5F5DC !important;
        }
        .nav-link:hover {
            background-color: #5C3A3A !important;
            color: #FFF !important;
            text-decoration: underline;
            border-radius: 5px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
        }
        .card {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #dee2e6;
            padding: 30px;
        }
        h2 {
            color: #19202f;
        }
        .btn-back {
            margin-top: 20px;
            color: #19202f;
            border-color: #19202f;
        }
        .btn-back:hover {
            background-color: #19202f;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon" style="filter: invert(1);"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav d-flex flex-row">
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard" style="font-weight: bold;">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/timetable">Timetable</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/resources">Study Resources</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/subjects">Subjects</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="study_groups">Study Groups</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/exams">Exam Schedules</a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="d-flex align-items-center">
                <% if (user.role === 'admin') { %>
                    <a href="/admin" class="btn admin-btn" style="background-color: #D9A404; color: #2C1810; margin-right: 0.5rem; font-weight: bold; border: none; padding: 0.5rem 1rem; border-radius: 5px; text-decoration: none; transition: background-color 0.3s ease;">
                        Admin Dashboard
                    </a>
                <% } %>
                <a href="/logout" class="btn logout-btn" style="background-color: #B83A3A; color: #F5F5DC; font-weight: bold; border: none; padding: 0.5rem 1rem; border-radius: 5px; text-decoration: none; transition: background-color 0.3s ease;">
                    Logout
                </a>
            </div>
        </div>
    </nav>
</div>

    <div class="container">
        <h1 class="mb-4"> My Study Timetable</h1>

        <!-- Flash Messages -->
        <% if (typeof messages !== 'undefined') { %>
            <% if (messages.success && messages.success.length > 0) { %>
                <div class="alert alert-success alert-dismissible fade show">
                    <%= messages.success[0] %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <% } %>
            <% if (messages.error && messages.error.length > 0) { %>
                <div class="alert alert-danger alert-dismissible fade show">
                    <%= messages.error[0] %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            <% } %>
        <% } %>

        <!-- SEARCH SECTION - Your missing search button! -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"> Search Timetable</h5>
            </div>
            <div class="card-body">
                <form id="searchForm" class="mb-3">
                    <div class="row">
                        <div class="col-md-5">
                            <input type="text" class="form-control" id="searchSubject" 
                                   placeholder="Search by subject..." onkeyup="searchTimetable()">
                        </div>
                        <div class="col-md-5">
                            <select class="form-control" id="searchDay" onchange="searchTimetable()">
                                <option value="">Search by day...</option>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                                <option value="Sunday">Sunday</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearSearch()">
                                Clear
                            </button>
                        </div>
                    </div>
                </form>
                <div id="searchResults" style="display: none;">
                    <div class="alert alert-info">
                        <span id="searchCount">0</span> results found
                    </div>
                </div>
            </div>
        </div>

        <!-- Add New Entry Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"> Add New Timetable Entry</h5>
            </div>
            <div class="card-body">
                <form action="/timetable/add" method="POST">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="subject" class="form-label">Subject</label>
                                <input type="text" class="form-control" id="subject" name="subject" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="day" class="form-label">Day</label>
                                <select class="form-control" id="day" name="day" required>
                                    <option value="">Select Day</option>
                                    <option value="Monday">Monday</option>
                                    <option value="Tuesday">Tuesday</option>
                                    <option value="Wednesday">Wednesday</option>
                                    <option value="Thursday">Thursday</option>
                                    <option value="Friday">Friday</option>
                                    <option value="Saturday">Saturday</option>
                                    <option value="Sunday">Sunday</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="time_slot" class="form-label">Time Slot</label>
                                <input type="text" class="form-control" id="time_slot" name="time_slot" 
                                       placeholder="e.g., 9:00 AM - 10:00 AM" required>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Entry</button>
                </form>
            </div>
        </div>

        <!-- Timetable Entries -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"> Timetable</h5>
            </div>
            <div class="card-body">
                <!-- Check if entries exist and handle errors -->
                <% if (typeof entries === 'undefined') { %>
                    <div class="alert alert-warning">
                        <strong> Data Loading Error:</strong> Unable to load timetable entries. Please refresh the page.
                    </div>
                <% } else if (!entries || entries.length === 0) { %>
                    <div class="alert alert-info text-center">
                        <h5> No Timetable Entries Found</h5>
                        <p>Get started by adding your first timetable entry above!</p>
                    </div>
                <% } else { %>
                    <div class="table-responsive">
                        <table class="table table-hover" id="timetableTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Subject</th>
                                    <th>Day</th>
                                    <th>Time Slot</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="timetableBody">
                                <% entries.forEach(function(timetableEntry, index) { %>
                                    <tr class="timetable-row" 
                                        data-subject="<%= (timetableEntry.subject || timetableEntry.subject_name || '').toLowerCase() %>"
                                        data-day="<%= (timetableEntry.day || '').toLowerCase() %>">
                                        <td>
                                            <strong><%= timetableEntry.subject || timetableEntry.subject_name || 'Unknown Subject' %></strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary"><%= timetableEntry.day || 'TBD' %></span>
                                        </td>
                                        <td>
                                            <%= timetableEntry.time_slot || 'No time set' %>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <!-- Edit Button (triggers modal) -->
                                                <button type="button" class="btn btn-sm btn-outline-secondary" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#editModal<%= timetableEntry.id %>">
                                                    Edit
                                                </button>
                                                
                                                <!-- Delete Button -->
                                                <a href="/timetable/delete/<%= timetableEntry.id %>" 
                                                   class="btn btn-sm btn-outline-danger"
                                                   onclick="return confirm('Are you sure you want to delete this entry?')">
                                                    Delete
                                                </a>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Edit Modal for this entry -->
                                    <div class="modal fade" id="editModal<%= timetableEntry.id %>" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Edit Timetable Entry</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <form action="/timetable/edit/<%= timetableEntry.id %>" method="POST">
                                                    <div class="modal-body">
                                                        <div class="mb-3">
                                                            <label for="editSubject<%= timetableEntry.id %>" class="form-label">Subject</label>
                                                            <input type="text" class="form-control" 
                                                                   id="editSubject<%= timetableEntry.id %>" 
                                                                   name="subject" 
                                                                   value="<%= timetableEntry.subject || timetableEntry.subject_name || '' %>" 
                                                                   required>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="editDay<%= timetableEntry.id %>" class="form-label">Day</label>
                                                            <select class="form-control" 
                                                                    id="editDay<%= timetableEntry.id %>" 
                                                                    name="day" required>
                                                                <option value="Monday" <%= timetableEntry.day === 'Monday' ? 'selected' : '' %>>Monday</option>
                                                                <option value="Tuesday" <%= timetableEntry.day === 'Tuesday' ? 'selected' : '' %>>Tuesday</option>
                                                                <option value="Wednesday" <%= timetableEntry.day === 'Wednesday' ? 'selected' : '' %>>Wednesday</option>
                                                                <option value="Thursday" <%= timetableEntry.day === 'Thursday' ? 'selected' : '' %>>Thursday</option>
                                                                <option value="Friday" <%= timetableEntry.day === 'Friday' ? 'selected' : '' %>>Friday</option>
                                                                <option value="Saturday" <%= timetableEntry.day === 'Saturday' ? 'selected' : '' %>>Saturday</option>
                                                                <option value="Sunday" <%= timetableEntry.day === 'Sunday' ? 'selected' : '' %>>Sunday</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="editTimeSlot<%= timetableEntry.id %>" class="form-label">Time Slot</label>
                                                            <input type="text" class="form-control" 
                                                                   id="editTimeSlot<%= timetableEntry.id %>" 
                                                                   name="time_slot" 
                                                                   value="<%= timetableEntry.time_slot || '' %>" 
                                                                   required>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                                        <button type="submit" class="btn btn-primary">Save Changes</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- SEARCH FUNCTIONALITY - Your missing search feature! -->
    <script>
        // Search function that filters by subject or day
        function searchTimetable() {
            const searchSubject = document.getElementById('searchSubject').value.toLowerCase();
            const searchDay = document.getElementById('searchDay').value.toLowerCase();
            const rows = document.querySelectorAll('.timetable-row');
            const searchResults = document.getElementById('searchResults');
            const searchCount = document.getElementById('searchCount');
            
            let visibleCount = 0;
            
            rows.forEach(row => {
                const rowSubject = row.getAttribute('data-subject');
                const rowDay = row.getAttribute('data-day');
                
                const subjectMatch = !searchSubject || rowSubject.includes(searchSubject);
                const dayMatch = !searchDay || rowDay === searchDay;
                
                if (subjectMatch && dayMatch) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Show search results count
            if (searchSubject || searchDay) {
                searchResults.style.display = 'block';
                searchCount.textContent = visibleCount;
            } else {
                searchResults.style.display = 'none';
            }
        }
        
        // Clear search function
        function clearSearch() {
            document.getElementById('searchSubject').value = '';
            document.getElementById('searchDay').value = '';
            document.getElementById('searchResults').style.display = 'none';
            
            // Show all rows
            const rows = document.querySelectorAll('.timetable-row');
            rows.forEach(row => {
                row.style.display = '';
            });
        }
    </script>
    
    <!-- Error Prevention Script -->
    <script>
        // Prevent form resubmission on page refresh
        if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
        }

        // Auto-hide alerts after 5 seconds
        setTimeout(function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                if (alert.classList.contains('show')) {
                    alert.classList.remove('show');
                }
            });
        }, 5000);

        // Form validation
        document.addEventListener('DOMContentLoaded', function() {
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function(e) {
                    const inputs = form.querySelectorAll('input[required], select[required]');
                    let valid = true;
                    
                    inputs.forEach(input => {
                        if (!input.value.trim()) {
                            valid = false;
                            input.classList.add('is-invalid');
                        } else {
                            input.classList.remove('is-invalid');
                        }
                    });
                    
                    if (!valid) {
                        e.preventDefault();
                        alert('Please fill in all required fields.');
                    }
                });
            });
        });
    </script>

    <footer class="footer">
        <p>&copy; SG Study Buddy & Co.</p>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>